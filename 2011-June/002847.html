<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [fetchmail-users] Mangled MIME boundaries
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/fetchmail-users/2011-June/index.html" >
   <LINK REL="made" HREF="mailto:fetchmail-users%40lists.berlios.de?Subject=Re%3A%20%5Bfetchmail-users%5D%20Mangled%20MIME%20boundaries&In-Reply-To=%3C4DE7FBF2.2090905%40gmx.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002846.html">
   <LINK REL="Next"  HREF="002848.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[fetchmail-users] Mangled MIME boundaries</H1>
    <B>Matthias Andree</B> 
    <A HREF="mailto:fetchmail-users%40lists.berlios.de?Subject=Re%3A%20%5Bfetchmail-users%5D%20Mangled%20MIME%20boundaries&In-Reply-To=%3C4DE7FBF2.2090905%40gmx.de%3E"
       TITLE="[fetchmail-users] Mangled MIME boundaries">matthias.andree at gmx.de
       </A><BR>
    <I>Thu Jun  2 23:09:06 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002846.html">[fetchmail-users] Mangled MIME boundaries
</A></li>
        <LI>Next message: <A HREF="002848.html">[fetchmail-users] Mangled MIME boundaries
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2847">[ date ]</a>
              <a href="thread.html#2847">[ thread ]</a>
              <a href="subject.html#2847">[ subject ]</a>
              <a href="author.html#2847">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am 01.06.2011 20:50, schrieb Jack Repenning:
&gt;<i> On some mail I receive, the boundary marker declared in the message &quot;Content-type&quot; header is not the one actually used to separate the message parts. For my mail client (Apple Mail), this causes the message bodies to display as raw text (often, of course, in base64).
</I>&gt;<i> 
</I>&gt;<i> I've investigated enough to determine that these markers (both the declared one, and the one actually used) are being changed right about at the point fetchmail pulls the message over (from Exchange Server 2003). Is this a familiar syndrome? Is there a way to make it stop?
</I>&gt;<i> 
</I>&gt;<i> More details:
</I>&gt;<i> 
</I>&gt;<i> This doesn't happen to all mail; in fact, most mail is just fine. But certain types of messages always get this damage, so these messages are never human-readable. One case I've studied very closely is post-commit Subversion notices with diffs, and all further details mentioned here come specifically from that particular case.
</I>&gt;<i> 
</I>&gt;<i> Tracing things from the point of origin: the messages are sent with the Perl MIME::Lite mod. The boundary markers generated by MIME::Lite are something like 
</I>&gt;<i> 
</I>&gt;<i>   _---NNNNNN
</I>&gt;<i> 
</I>&gt;<i> where the NNNNN is some number (PID concatenated with time-as-milliseconds-since-epoc, or something like that). MIME::Lite uses the same boundary marker as it declares, as is proper.
</I>&gt;<i> 
</I>&gt;<i> My mail passes through Microsoft Exchange Server 2003. If I retrieve the mail from there into Microsoft Outlook, using &quot;Exchange&quot; protocol, it looks the same as just described: boundary markers like +---NNNNNN, both declared and actually used, and matching, and the message displays cleanly.
</I>&gt;<i> 
</I>&gt;<i> If I retrieve the mail from Exchange into Apple Mail via IMAP, though, things are slightly different. The boundaries (both declared and used) have changed to something like
</I>&gt;<i> 
</I>&gt;<i>   ------=_NextPart_000_7D7FF8_01CC2088.05111FB8
</I>&gt;<i> 
</I>&gt;<i> At this point, however, the declared and used markers are still the same, and the message displays properly.
</I>&gt;<i> 
</I>&gt;<i> Chipping away at the problem from the other end, my normal process is to use fetchmail to fetch mail via IMAP, delivered into a local mbox via procmail, and to read it in Apple Mail via POP3. I replaced procmail with &quot;tee -a someotherfile | procmail&quot;, and confirmed that the boundary markers in &quot;someotherfile&quot; have the &quot;NextPart&quot; form just mentioned, but the declared and used markers are mismatched--in other words, the data presented to procmail is exactly the same as what I read by the time it gets into Apple Mail. Neither procmail nor qpopper nor Apple Mail is doing the damage.
</I>&gt;<i> 
</I>&gt;<i> That leaves Exchange Server 2003, IMAP, and fetchmail straddling the point where the damage is done. Since Exchange does change the boundary form from NNNN to NextPart (and since strings is unable to find &quot;NextPart&quot; in the fetchmail binary), my messed-up declared-unmatches-used boundaries seem very likely to be entirely busticated by Exchange. But since Apple Mail can get readable (though modified) mail by IMAP, while fetchmail gets unreadable, mangled mail by IMAP, it seems like Exchange is doing something different in the two cases, and perhaps that's due to some parameter passed from fetchmail to Exchange. But I can't figure out what's different between the fetchmail fetches and the Mail fetches (partly because my IMAP connection to Exchange is encrypted, so tracing is no help).
</I>
Hi Jack,

sorry to hear of the troubles.

I'll need to have a second look at the fetchmail code, play a bit with
various servers and MIME::Lite, however, I do not currently have a test
account on any Exchange server, so I cannot reproduce any Exchange
problem.

One question before: are you using fetchmail's unmime/mimedecode option?
 It's off by default, but affects decoding.

You can, however, trace the fetchmail-to-Exchange conversation in
verbose mode, see &lt;<A HREF="http://www.fetchmail.info/fetchmail-FAQ.html#G3">http://www.fetchmail.info/fetchmail-FAQ.html#G3</A>&gt;.

If you can do similar things with Apple Mail, that would help, we could
then compare the commands used, and close in on who or what is the
culprit.  Alternatively, if you can install Thunderbird on the MAC, it
supports tracing, and if it doesn't have the problem either, but
fetchmail still does, we're closer to my reproducing it.

Best regards,
Matthias

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002846.html">[fetchmail-users] Mangled MIME boundaries
</A></li>
	<LI>Next message: <A HREF="002848.html">[fetchmail-users] Mangled MIME boundaries
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2847">[ date ]</a>
              <a href="thread.html#2847">[ thread ]</a>
              <a href="subject.html#2847">[ subject ]</a>
              <a href="author.html#2847">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/fetchmail-users">More information about the fetchmail-users
mailing list</a><br>
</body></html>
